// ========================================
// üìù GOOGLE APPS SCRIPT - VERSI√ìN ACTUALIZADA
// ========================================
// NUEVAS FUNCIONALIDADES:
// - Campo "Estado" en Simulaciones
// - Nueva pesta√±a "TelefonoAdmin"
// - Notificaci√≥n autom√°tica por WhatsApp al admin
// ========================================

const SHEET_ID = '19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';

// ========================================
// üÜï FUNCI√ìN PARA OBTENER TEL√âFONO DEL ADMIN
// ========================================
function obtenerTelefonoAdmin() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID);
    const telefonoSheet = sheet.getSheetByName('TelefonoAdmin');
    
    if (!telefonoSheet) {
      Logger.log('‚ö†Ô∏è No existe pesta√±a TelefonoAdmin, cre√°ndola...');
      const nuevaHoja = sheet.insertSheet('TelefonoAdmin');
      
      // Crear estructura
      nuevaHoja.appendRow(['Tel√©fono Admin', 'Activo']);
      nuevaHoja.appendRow(['5214422580524', 'TRUE']);
      
      // Formatear
      const headerRange = nuevaHoja.getRange(1, 1, 1, 2);
      headerRange.setBackground('#667eea');
      headerRange.setFontColor('#ffffff');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
      nuevaHoja.setFrozenRows(1);
      nuevaHoja.setColumnWidth(1, 200);
      
      Logger.log('‚úÖ Pesta√±a TelefonoAdmin creada');
      return '5214422580524'; // Valor por defecto
    }
    
    const data = telefonoSheet.getDataRange().getValues();
    
    // Verificar si las notificaciones est√°n activas
    const activo = data[1] && data[1][1] ? String(data[1][1]).toUpperCase() === 'TRUE' : false;
    
    if (!activo) {
      Logger.log('‚ö†Ô∏è Notificaciones desactivadas');
      return null;
    }
    
    const telefono = data[1] && data[1][0] ? String(data[1][0]).trim() : null;
    
    if (!telefono) {
      Logger.log('‚ö†Ô∏è No hay tel√©fono configurado');
      return null;
    }
    
    Logger.log('‚úÖ Tel√©fono admin obtenido: ' + telefono);
    return telefono;
    
  } catch (error) {
    Logger.log('‚ùå Error al obtener tel√©fono admin: ' + error.toString());
    return null;
  }
}

// ========================================
// üÜï FUNCI√ìN PARA ENVIAR NOTIFICACI√ìN AL ADMIN
// ========================================
function enviarNotificacionAdmin(datos, idSimulacion) {
  try {
    const telefonoAdmin = obtenerTelefonoAdmin();
    
    if (!telefonoAdmin) {
      Logger.log('‚ö†Ô∏è No se enviar√° notificaci√≥n (tel√©fono no configurado o desactivado)');
      return;
    }
    
    // Crear mensaje de notificaci√≥n
    let mensaje = `üîî *NUEVA SIMULACI√ìN REGISTRADA*\n\n`;
    mensaje += `üÜî *ID:* ${idSimulacion}\n`;
    mensaje += `üìÖ *Fecha:* ${datos.fecha}\n\n`;
    
    mensaje += `üí∞ *Capital:* ${formatMoneyForNotification(datos.capital)}\n`;
    mensaje += `üìä *Inter√©s:* ${datos.interesPorc}%\n`;
    mensaje += `üíµ *Total a Prestar:* ${formatMoneyForNotification(datos.totalPrestar)}\n`;
    mensaje += `üìÜ *Plazo:* ${datos.dias} d√≠as\n`;
    mensaje += `üí≥ *Pago Diario:* ${formatMoneyForNotification(datos.pagoDiario)}\n\n`;
    
    // Estado de los datos
    mensaje += `üìã *Estado:* ${datos.estado}\n\n`;
    
    // Informaci√≥n del cliente (si existe)
    if (datos.nombre && datos.nombre !== 'Sin datos') {
      mensaje += `üë§ *Cliente:* ${datos.nombre}\n`;
    }
    if (datos.telefono && datos.telefono !== 'Sin datos') {
      mensaje += `üì± *Tel√©fono:* ${datos.telefono}\n`;
    }
    
    // Ubicaci√≥n (si existe)
    if (datos.latitud && datos.longitud) {
      mensaje += `\nüìç *Ubicaci√≥n registrada*\n`;
      mensaje += `üó∫Ô∏è https://www.google.com/maps?q=${datos.latitud},${datos.longitud}\n`;
    }
    
    // Documentos (si existen)
    if ((datos.fotoINE && datos.fotoINE.length > 100) || 
        (datos.fotoComprobante && datos.fotoComprobante.length > 100)) {
      mensaje += `\nüìÑ *Documentos:* `;
      let docs = [];
      if (datos.fotoINE && datos.fotoINE.length > 100) docs.push('INE');
      if (datos.fotoComprobante && datos.fotoComprobante.length > 100) docs.push('Comprobante');
      mensaje += docs.join(', ') + ' ‚úì\n';
    }
    
    mensaje += `\nüìä Ver detalles en Google Sheets`;
    
    // Generar URL de WhatsApp
    const urlWhatsApp = `https://wa.me/${telefonoAdmin}?text=${encodeURIComponent(mensaje)}`;
    
    Logger.log('üì§ Notificaci√≥n preparada para: ' + telefonoAdmin);
    Logger.log('üìù URL: ' + urlWhatsApp);
    
    // Guardar la URL de notificaci√≥n en una hoja temporal (opcional)
    try {
      const sheet = SpreadsheetApp.openById(SHEET_ID);
      let notifSheet = sheet.getSheetByName('NotificacionesPendientes');
      
      if (!notifSheet) {
        notifSheet = sheet.insertSheet('NotificacionesPendientes');
        notifSheet.appendRow(['Fecha', 'ID Simulaci√≥n', 'URL Notificaci√≥n', 'Enviada']);
        notifSheet.getRange(1, 1, 1, 4).setBackground('#667eea').setFontColor('#ffffff').setFontWeight('bold');
      }
      
      notifSheet.appendRow([
        new Date().toLocaleString('es-MX'),
        idSimulacion,
        urlWhatsApp,
        'Pendiente'
      ]);
      
      Logger.log('‚úÖ URL de notificaci√≥n guardada');
    } catch (error) {
      Logger.log('‚ö†Ô∏è No se pudo guardar URL de notificaci√≥n: ' + error.toString());
    }
    
    return urlWhatsApp;
    
  } catch (error) {
    Logger.log('‚ùå Error al enviar notificaci√≥n: ' + error.toString());
    return null;
  }
}

// ========================================
// üõ†Ô∏è FUNCI√ìN AUXILIAR PARA FORMATEAR DINERO
// ========================================
function formatMoneyForNotification(num) {
  return '$' + Number(num).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
}

// ========================================
// GET - Funcionalidad original (SIN CAMBIOS)
// ========================================
function doGet(e) {
  const sheet = SpreadsheetApp.openById(SHEET_ID);
  const tipo = e.parameter.tipo || 'parametros';
  
  if (tipo === 'parametros') {
    const parametrosSheet = sheet.getSheetByName('Parametros');
    const data = parametrosSheet.getDataRange().getValues();
    const resultado = [];
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][1] && data[i][2]) {
        resultado.push({
          interes: Number(data[i][0]),
          meses: Number(data[i][1]),
          capital: Number(data[i][2])
        });
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify(resultado)).setMimeType(ContentService.MimeType.JSON);
  }
  
  if (tipo === 'admin') {
    const adminSheet = sheet.getSheetByName('Admin');
    if (!adminSheet) {
      return ContentService.createTextOutput(JSON.stringify({activo: false, mensaje: ''})).setMimeType(ContentService.MimeType.JSON);
    }
    
    const data = adminSheet.getDataRange().getValues();
    const activo = data[1] && data[1][0] ? String(data[1][0]).toUpperCase() === 'TRUE' : false;
    const mensaje = data[1] && data[1][1] ? String(data[1][1]) : '';
    
    return ContentService.createTextOutput(JSON.stringify({activo: activo, mensaje: mensaje})).setMimeType(ContentService.MimeType.JSON);
  }
  
  if (tipo === 'banner') {
    const bannerSheet = sheet.getSheetByName('Banner');
    if (!bannerSheet) {
      return ContentService.createTextOutput(JSON.stringify({
        activo: false, 
        texto: ''
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const data = bannerSheet.getDataRange().getValues();
    const activo = data[1] && data[1][0] ? String(data[1][0]).toUpperCase() === 'TRUE' : false;
    const texto = data[1] && data[1][1] ? String(data[1][1]) : '';
    
    return ContentService.createTextOutput(JSON.stringify({
      activo: activo, 
      texto: texto
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ========================================
// FUNCI√ìN PARA GENERAR ID √öNICO (SIN CAMBIOS)
// ========================================
function generarID() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let random = '';
  for (let i = 0; i < 4; i++) {
    random += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  
  return `SIM-${year}${month}${day}-${hours}${minutes}${seconds}-${random}`;
}

// ========================================
// üÜï POST - Guardar simulaciones (ACTUALIZADO)
// ========================================
function doPost(e) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID);
    const datos = JSON.parse(e.postData.contents);
    
    // Generar ID √∫nico
    const idSimulacion = generarID();
    Logger.log('üÜî ID generado: ' + idSimulacion);
    
    // üÜï DETERMINAR ESTADO seg√∫n los datos recibidos
    let estado = datos.estado || 'Sin datos';
    if (datos.nombre && datos.nombre !== 'Sin datos' && 
        datos.telefono && datos.telefono !== 'Sin datos') {
      estado = 'Completo';
    }
    
    // Obtener o crear la pesta√±a "Simulaciones"
    let simulacionesSheet = sheet.getSheetByName('Simulaciones');
    
    if (!simulacionesSheet) {
      simulacionesSheet = sheet.insertSheet('Simulaciones');
      
      // Crear encabezados completos (ID en primera columna)
      simulacionesSheet.appendRow([
        'ID',                    // A - Columna 1
        'Fecha/Hora',           // B - Columna 2
        'Nombre Cliente',       // C - Columna 3
        'Tel√©fono',            // D - Columna 4
        'Capital',             // E - Columna 5
        'D√≠as',                // F - Columna 6
        'Inter√©s %',           // G - Columna 7
        'Inter√©s $',           // H - Columna 8
        'Total a Prestar',     // I - Columna 9
        'Pago Diario',         // J - Columna 10
        'Latitud',             // K - Columna 11
        'Longitud',            // L - Columna 12
        'Direcci√≥n',           // M - Columna 13
        'Link Mapa',           // N - Columna 14
        'Foto INE',            // O - Columna 15
        'Foto Comprobante',    // P - Columna 16
        'Estado',              // Q - Columna 17 üÜï
        'Notas'                // R - Columna 18
      ]);
      
      // Formatear encabezados
      const headerRange = simulacionesSheet.getRange(1, 1, 1, 18);
      headerRange.setBackground('#667eea');
      headerRange.setFontColor('#ffffff');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
      simulacionesSheet.setFrozenRows(1);
      
      simulacionesSheet.setColumnWidth(1, 200);  // ID
      simulacionesSheet.setColumnWidth(3, 150);  // Nombre
      simulacionesSheet.setColumnWidth(13, 300); // Direcci√≥n
      
      Logger.log('‚úÖ Pesta√±a creada con estructura actualizada');
    }
    
    // Guardar fotos en Google Drive
    let urlINE = '';
    let urlComprobante = '';
    
    try {
      const carpetaNombre = `${idSimulacion}_${datos.nombre.replace(/\s+/g, '_')}`;
      const carpetaPrincipal = obtenerOCrearCarpeta('Simulaciones_Prestamos');
      const carpetaCliente = carpetaPrincipal.createFolder(carpetaNombre);
      
      if (datos.fotoINE && datos.fotoINE.length > 100) {
        const blobINE = convertirBase64ABlob(datos.fotoINE);
        const archivoINE = carpetaCliente.createFile(blobINE);
        archivoINE.setName(`INE_${idSimulacion}.jpg`);
        archivoINE.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        urlINE = archivoINE.getUrl();
        Logger.log('‚úÖ Foto INE guardada');
      }
      
      if (datos.fotoComprobante && datos.fotoComprobante.length > 100) {
        const blobComprobante = convertirBase64ABlob(datos.fotoComprobante);
        const archivoComprobante = carpetaCliente.createFile(blobComprobante);
        archivoComprobante.setName(`Comprobante_${idSimulacion}.jpg`);
        archivoComprobante.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        urlComprobante = archivoComprobante.getUrl();
        Logger.log('‚úÖ Foto Comprobante guardada');
      }
      
    } catch (errorDrive) {
      Logger.log('‚ö†Ô∏è Error al guardar en Drive: ' + errorDrive.toString());
      urlINE = datos.fotoINE && datos.fotoINE.length > 100 ? 'Error al guardar' : 'No disponible';
      urlComprobante = datos.fotoComprobante && datos.fotoComprobante.length > 100 ? 'Error al guardar' : 'No disponible';
    }
    
    // Crear link de Google Maps
    const linkMapa = datos.latitud && datos.longitud 
      ? `https://www.google.com/maps?q=${datos.latitud},${datos.longitud}` 
      : '';
    
    // Agregar fila con TODOS los datos
    simulacionesSheet.appendRow([
      idSimulacion,                           // A - ID √∫nico
      datos.fecha,                           // B - Fecha/Hora
      datos.nombre || 'Sin datos',           // C - Nombre
      datos.telefono || 'Sin datos',         // D - Tel√©fono
      datos.capital,                         // E - Capital
      datos.dias,                            // F - D√≠as
      datos.interesPorc,                     // G - Inter√©s %
      datos.interesTotal,                    // H - Inter√©s $
      datos.totalPrestar,                    // I - Total
      datos.pagoDiario,                      // J - Pago Diario
      datos.latitud || '',                   // K - Latitud
      datos.longitud || '',                  // L - Longitud
      datos.direccion || '',                 // M - Direcci√≥n
      linkMapa,                              // N - Link Mapa
      urlINE || 'No disponible',             // O - Foto INE
      urlComprobante || 'No disponible',     // P - Foto Comprobante
      estado,                                // Q - Estado üÜï
      ''                                     // R - Notas
    ]);
    
    // Formatear la √∫ltima fila
    const lastRow = simulacionesSheet.getLastRow();
    
    simulacionesSheet.getRange(lastRow, 5).setNumberFormat('$#,##0.00');
    simulacionesSheet.getRange(lastRow, 8).setNumberFormat('$#,##0.00');
    simulacionesSheet.getRange(lastRow, 9).setNumberFormat('$#,##0.00');
    simulacionesSheet.getRange(lastRow, 10).setNumberFormat('$#,##0.00');
    simulacionesSheet.getRange(lastRow, 7).setNumberFormat('0.0"%"');
    
    if (linkMapa) {
      simulacionesSheet.getRange(lastRow, 14).setFormula(`=HYPERLINK("${linkMapa}", "üìç Ver en Mapa")`);
    }
    if (urlINE && urlINE !== 'Error al guardar' && urlINE !== 'No disponible') {
      simulacionesSheet.getRange(lastRow, 15).setFormula(`=HYPERLINK("${urlINE}", "üìÑ Ver INE")`);
    }
    if (urlComprobante && urlComprobante !== 'Error al guardar' && urlComprobante !== 'No disponible') {
      simulacionesSheet.getRange(lastRow, 16).setFormula(`=HYPERLINK("${urlComprobante}", "üìÑ Ver Comprobante")`);
    }
    
    // üÜï Colorear el estado seg√∫n el valor
    const estadoCell = simulacionesSheet.getRange(lastRow, 17);
    estadoCell.setFontWeight('bold');
    
    if (estado === 'Completo') {
      estadoCell.setBackground('#C8E6C9');  // Verde claro
      estadoCell.setValue('‚úÖ ' + estado);
    } else {
      estadoCell.setBackground('#FFF9C4');  // Amarillo claro
      estadoCell.setValue('‚ö†Ô∏è ' + estado);
    }
    
    Logger.log('‚úÖ Simulaci√≥n guardada con ID: ' + idSimulacion);
    Logger.log('üìä Estado: ' + estado);
    
    // üÜï ENVIAR NOTIFICACI√ìN AL ADMIN
    const urlNotificacion = enviarNotificacionAdmin(datos, idSimulacion);
    
    return ContentService.createTextOutput(JSON.stringify({
      'status': 'success',
      'message': 'Datos guardados correctamente',
      'id': idSimulacion,
      'row': lastRow,
      'estado': estado,
      'notificacion': urlNotificacion || 'No configurada'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('‚ùå Error: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      'status': 'error',
      'message': error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ========================================
// FUNCIONES AUXILIARES (SIN CAMBIOS)
// ========================================

function convertirBase64ABlob(base64String) {
  try {
    const partes = base64String.split(',');
    const mimeType = partes[0].match(/:(.*?);/)[1];
    const data = Utilities.base64Decode(partes[1]);
    return Utilities.newBlob(data, mimeType, 'imagen.jpg');
  } catch (error) {
    Logger.log('Error al convertir Base64: ' + error.toString());
    throw error;
  }
}

function obtenerOCrearCarpeta(nombreCarpeta) {
  const carpetas = DriveApp.getFoldersByName(nombreCarpeta);
  if (carpetas.hasNext()) {
    return carpetas.next();
  } else {
    return DriveApp.createFolder(nombreCarpeta);
  }
}

// ========================================
// üß™ TEST ACTUALIZADO
// ========================================
function testSimulacionCompleta() {
  Logger.log('========================================');
  Logger.log('üß™ TEST DE SIMULACI√ìN COMPLETA');
  Logger.log('========================================');
  
  const imagenPrueba = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8DwHwAFBQIAX8jx0gAAAABJRU5ErkJggg==';
  
  const testData = {
    postData: {
      contents: JSON.stringify({
        fecha: new Date().toLocaleString('es-MX'),
        nombre: 'Juan P√©rez Test',
        telefono: '4421234567',
        capital: 5000,
        dias: 27,
        interesPorc: 21.5,
        interesTotal: 1075,
        totalPrestar: 6075,
        pagoDiario: 225,
        fotoINE: imagenPrueba,
        fotoComprobante: imagenPrueba,
        latitud: 20.5888,
        longitud: -100.3899,
        direccion: 'Quer√©taro, Qro., M√©xico (Prueba)',
        estado: 'Completo'
      })
    }
  };
  
  Logger.log('üì§ Enviando datos de prueba...');
  const result = doPost(testData);
  const respuesta = JSON.parse(result.getContent());
  
  Logger.log('========================================');
  Logger.log('üì• RESPUESTA:');
  Logger.log('Estado: ' + respuesta.status);
  Logger.log('ID: ' + respuesta.id);
  Logger.log('Fila: ' + respuesta.row);
  Logger.log('Estado datos: ' + respuesta.estado);
  Logger.log('========================================');
}

// ========================================
// üß™ TEST SIN DATOS
// ========================================
function testSimulacionSinDatos() {
  Logger.log('========================================');
  Logger.log('üß™ TEST DE SIMULACI√ìN SIN DATOS');
  Logger.log('========================================');
  
  const testData = {
    postData: {
      contents: JSON.stringify({
        fecha: new Date().toLocaleString('es-MX'),
        nombre: 'Sin datos',
        telefono: 'Sin datos',
        capital: 3000,
        dias: 40,
        interesPorc: 32,
        interesTotal: 960,
        totalPrestar: 3960,
        pagoDiario: 99,
        fotoINE: '',
        fotoComprobante: '',
        latitud: '',
        longitud: '',
        direccion: '',
        estado: 'Sin datos'
      })
    }
  };
  
  Logger.log('üì§ Enviando simulaci√≥n sin datos...');
  const result = doPost(testData);
  const respuesta = JSON.parse(result.getContent());
  
  Logger.log('========================================');
  Logger.log('üì• RESPUESTA:');
  Logger.log('Estado: ' + respuesta.status);
  Logger.log('ID: ' + respuesta.id);
  Logger.log('Estado datos: ' + respuesta.estado);
  Logger.log('========================================');
}
